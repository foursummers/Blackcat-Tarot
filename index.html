<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å–µå–µå¡”ç½— - å‘½è¿å›å“ç‰ˆ</title>
    <!-- å¼•å…¥ MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        /* --- æ•´ä½“æ°›å›´è®¾ç½® --- */
        body { 
            margin: 0; overflow: hidden; 
            background: #0a0a0a; 
            color: #e0e0e0; 
            font-family: 'Georgia', 'Times New Roman', serif;
            user-select: none; 
        }
        
        /* è§†é¢‘å±‚ */
        #output_canvas { 
            position: absolute; left: 0; top: 0; width: 100%; height: 100%; 
            transform: scaleX(-1); 
            object-fit: cover;
            opacity: 0.3; 
            filter: grayscale(80%) contrast(1.2); 
        }
        
        /* UI å±‚ */
        #ui-layer { 
            position: absolute; width: 100%; height: 100%; 
            pointer-events: none; 
            perspective: 1200px; 
            overflow: hidden;
            z-index: 10;
        }

        /* é¡¶éƒ¨æç¤ºæ  */
        #header {
            position: absolute; top: 20px; width: 100%; 
            text-align: center; z-index: 20;
            pointer-events: none;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            transition: opacity 0.5s;
        }
        h1 { 
            margin: 0; font-size: 20px; letter-spacing: 5px; 
            color: #d1d1d1; font-weight: normal; 
            opacity: 0.8;
        }
        #instruction { 
            margin-top: 10px; font-size: 14px; color: #a0a0a0; font-style: italic; 
            transition: all 0.5s ease;
            height: 20px;
        }
        .highlight { color: #fff; font-weight: bold; text-shadow: 0 0 5px #fff; }

        /* --- è§£è¯»é¢æ¿ --- */
        #reading-panel {
            position: absolute; 
            top: 12%; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 400px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
            display: flex; flex-direction: column; gap: 15px;
        }
        #reading-panel.show { opacity: 1; pointer-events: auto; }

        .reading-section { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .reading-section:last-child { border-bottom: none; padding-bottom: 0; }
        .reading-title { font-size: 12px; color: #ffd700; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 2px; }
        .reading-text { font-size: 14px; color: #eee; line-height: 1.5; text-align: justify; }

        /* --- å¡ç‰Œæ ·å¼ --- */
        .card {
            width: 80px; height: 136px;
            position: absolute;
            top: 50%; left: 50%;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        @media (min-width: 600px) {
            .card { width: 110px; height: 187px; }
        }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            overflow: hidden;
        }

        /* ç‰ŒèƒŒ */
        .card-back {
            background: #1a1a1a;
            border: 4px solid #5a5a5a;
            box-sizing: border-box;
            display: flex; align-items: center; justify-content: center;
            transform: rotateY(0deg);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
        }
        .card-back::after {
            content: ''; position: absolute;
            top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 1px solid #333;
            border-radius: 6px;
        }
        /* é»‘çŒ«å‰ªå½± */
        .cat-silhouette {
            width: 40px; height: 35px;
            background: #000;
            border-radius: 50% 50% 45% 45%;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .cat-silhouette::before, .cat-silhouette::after {
            content: ''; position: absolute; top: -8px;
            width: 0; height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 18px solid #000;
        }
        .cat-silhouette::before { left: -2px; transform: rotate(-15deg); }
        .cat-silhouette::after { right: -2px; transform: rotate(15deg); }
        .cat-eyes {
            position: absolute; top: 12px; left: 8px;
            width: 6px; height: 4px; background: #555; border-radius: 50%;
            box-shadow: 18px 0 0 #555;
        }

        /* ç‰Œé¢ */
        .card-front {
            background: #e3dac9;
            color: #2c2c2c;
            transform: rotateY(180deg);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border: 4px solid #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }
        .tarot-content { text-align: center; }
        .tarot-emoji { font-size: 36px; filter: sepia(0.5); margin-bottom: 5px; }
        .tarot-num { font-size: 10px; color: #888; margin-bottom: 2px; font-family: sans-serif; }
        .tarot-name { font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; border-top: 1px solid #aaa; border-bottom: 1px solid #aaa; padding: 2px 5px; }

        /* äº¤äº’çŠ¶æ€ */
        .card.selected {
            box-shadow: 0 0 15px rgba(255,255,255,0.6), 0 0 40px rgba(255,255,255,0.2);
            border-color: #fff;
            z-index: 999;
        }
        .slot-active {
            position: fixed !important;
            bottom: 30px !important;
            top: auto !important;
            margin: 0 !important;
            transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) !important;
        }
        .slot-1 { left: 20% !important; }
        .slot-2 { left: 50% !important; }
        .slot-3 { left: 80% !important; }

        /* å…‰æ ‡ */
        #cursor {
            width: 16px; height: 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            position: absolute; z-index: 2000;
            display: none;
            box-shadow: 0 0 15px #fff, 0 0 30px #fff;
            transform: translate(-50%, -50%);
            pointer-events: none;
            mix-blend-mode: overlay;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #080808; z-index: 5000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #666;
        }
        .moon-spinner {
            width: 40px; height: 40px; 
            border-radius: 50%;
            box-shadow: 6px 0 0 0 #fff;
            animation: moon-spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes moon-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="moon-spinner"></div>
        <div>å¬é›†é»‘çŒ«çµåŠ›ä¸­...</div>
    </div>

    <video id="input_video" style="display:none" playsinline webkit-playsinline></video>
    <canvas id="output_canvas"></canvas>

    <div id="header">
        <h1>BLACK CAT TAROT</h1>
        <p id="instruction">é—­çœ¼å†¥æƒ³ <span class="highlight">å¼ å¼€æ‰‹æŒ</span> å”¤é†’ç‰Œé˜µ</p>
    </div>

    <!-- è§£è¯»ç»“æœé¢æ¿ -->
    <div id="reading-panel">
        <div class="reading-section">
            <div class="reading-title">PAST è¿‡å»</div>
            <div class="reading-text" id="text-past">...</div>
        </div>
        <div class="reading-section">
            <div class="reading-title">PRESENT ç°åœ¨</div>
            <div class="reading-text" id="text-present">...</div>
        </div>
        <div class="reading-section">
            <div class="reading-title">FUTURE æœªæ¥</div>
            <div class="reading-text" id="text-future">...</div>
        </div>
    </div>

    <div id="ui-layer"></div>
    <div id="cursor"></div>

<script>
    // --- æ ¸å¿ƒæ•°æ® ---
    const tarotData = [
        { name: "The Fool", num: "0", emoji: "ğŸˆ", 
          meanings: { past: "è¿‡å»ä½ åƒå°çŒ«èˆ¬æ— ç•ï¼Œå¼€å¯äº†ä¸€æ®µæ–°æ—…ç¨‹ã€‚", present: "ç°åœ¨æ˜¯è¿ˆå‡ºå…³é”®ä¸€æ­¥çš„å¥½æ—¶æœºï¼Œç›¸ä¿¡ç›´è§‰ã€‚", future: "æœªæ¥å……æ»¡æ— é™å¯èƒ½ï¼Œæ–°çš„å†’é™©å³å°†å±•å¼€ã€‚" } },
        { name: "The Magician", num: "I", emoji: "ğŸ”®", 
          meanings: { past: "ä½ åˆ©ç”¨æ‰æ™ºå’Œèµ„æºï¼Œåˆ›é€ äº†æœ‰åˆ©çš„å¼€å±€ã€‚", present: "ä½ æ­£å¤„èƒ½é‡å·…å³°ï¼Œå·¥å…·åœ¨æ‰‹ï¼Œç«‹å³è¡ŒåŠ¨ã€‚", future: "æœªæ¥ä½ å°†åŒ–è…æœ½ä¸ºç¥å¥‡ï¼Œè¾¾æˆç›®æ ‡ã€‚" } },
        { name: "High Priestess", num: "II", emoji: "ğŸŒ™", 
          meanings: { past: "è¿‡å»ä½ ä¾èµ–ç†æ™ºï¼Œå´å¿½ç•¥äº†å†…å¿ƒæ·±å¤„çš„å£°éŸ³ã€‚", present: "é™ä¸‹å¿ƒæ¥ï¼Œå€¾å¬ç›´è§‰ï¼Œç­”æ¡ˆè—åœ¨æ½œæ„è¯†é‡Œã€‚", future: "æœªæ¥å°†æ­ç¤ºç§˜å¯†ï¼Œç›´è§‰æ˜¯ä½ æœ€å¼ºçš„æŒ‡å¼•ã€‚" } },
        { name: "The Empress", num: "III", emoji: "ğŸ‘‘", 
          meanings: { past: "è¿‡å»æ˜¯å……æ»¡å…³çˆ±ä¸ä¸°ç››çš„æ—¶æœŸï¼ŒåŸºç¡€ç¨³å›ºã€‚", present: "ç°åœ¨æ˜¯æ”¶è·æ—¶åˆ»ï¼Œå°½æƒ…é‡Šæ”¾ä½ çš„åˆ›é€ åŠ›ã€‚", future: "æœªæ¥å°†è¿æ¥ç‰©è´¨ä¸æƒ…æ„Ÿçš„åŒé‡ä¸°æ”¶ã€‚" } },
        { name: "The Emperor", num: "IV", emoji: "ğŸ¦", 
          meanings: { past: "è¿‡å»ä½ å»ºç«‹äº†ç¨³å›ºç§©åºï¼Œå±•ç°äº†é¢†å¯¼åŠ›ã€‚", present: "ç°åœ¨éœ€è¦ç†æ€§è‡ªå¾‹ï¼ŒæŒæ§å±€åŠ¿ï¼Œå»ºç«‹è§„åˆ™ã€‚", future: "æœªæ¥ä½ å°†è·å¾—ç¨³å›ºåœ°ä½ï¼Œç§©åºå¸¦æ¥æˆåŠŸã€‚" } },
        { name: "The Hierophant", num: "V", emoji: "ğŸ“œ", 
          meanings: { past: "è¿‡å»ä½ éµå¾ªä¼ ç»ŸæŒ‡å¼•ï¼Œè·å¾—äº†ç¾¤ä½“çš„è®¤åŒã€‚", present: "ç°åœ¨é€‚åˆå­¦ä¹ æˆ–å¯»æ±‚å»ºè®®ï¼Œä¸å®œæ‰“ç ´è§„åˆ™ã€‚", future: "æœªæ¥å°†è·å¾—ç²¾ç¥ä¸Šçš„æŒ‡å¼•ä¸å‡åã€‚" } },
        { name: "The Lovers", num: "VI", emoji: "ğŸ˜»", 
          meanings: { past: "è¿‡å»é¢ä¸´è¿‡é‡è¦é€‰æ‹©ï¼Œæˆ–å»ºç«‹äº†æ·±åˆ»è¿ç»“ã€‚", present: "ç°åœ¨é¢ä¸´æŠ‰æ‹©ï¼Œè·Ÿéšå†…å¿ƒï¼Œçˆ±æ˜¯å…³é”®ã€‚", future: "æœªæ¥å°†æœ‰ä¸€æ®µç¾å¥½çš„åˆä½œæˆ–æ‹æƒ…ã€‚" } },
        { name: "The Chariot", num: "VII", emoji: "ğŸ›’", 
          meanings: { past: "è¿‡å»å‡­æ„å¿—åŠ›å…‹æœäº†å›°éš¾ï¼ŒæŒæ§äº†æ–¹å‘ã€‚", present: "é›†ä¸­ç²¾åŠ›ï¼Œä¸èƒ½åœä¸‹ï¼Œå†²å‘ç›®æ ‡ã€‚", future: "é€šè¿‡è‡ªå¾‹å’ŒåšæŒï¼Œä½ å°†è·å¾—èƒœåˆ©ã€‚" } },
        { name: "Strength", num: "VIII", emoji: "ğŸ’ª", 
          meanings: { past: "è¿‡å»ä½ å±•ç°äº†æå¤§è€å¿ƒï¼ŒåŒ–è§£äº†å±æœºã€‚", present: "ä»¥æŸ”å…‹åˆšï¼Œç”¨ä¿¡å¿ƒé©¯æœç”Ÿæ´»ä¸­çš„çŒ›å…½ã€‚", future: "æœªæ¥ä½ å°†æ‹¥æœ‰æ— åšä¸æ‘§çš„å†…åœ¨åŠ›é‡ã€‚" } },
        { name: "The Hermit", num: "IX", emoji: "ğŸ•¯ï¸", 
          meanings: { past: "è¿‡å»ä½ ç‹¬è‡ªæ¢ç´¢ï¼Œå¯»æ‰¾å†…å¿ƒçš„çœŸç†ã€‚", present: "ç°åœ¨é€‚åˆç‹¬å¤„åæ€ï¼Œå‘å†…å¯»æ‰¾ç­”æ¡ˆã€‚", future: "æ·±æ€ç†Ÿè™‘åï¼Œä½ å°†æ‰¾åˆ°äººç”Ÿæ™ºæ…§ã€‚" } },
        { name: "Wheel of Fortune", num: "X", emoji: "ğŸ¡", 
          meanings: { past: "è¿‡å»ç»å†æ— æ³•æŒæ§çš„å˜åŠ¨ï¼Œæ˜ç™½äº†æ— å¸¸ã€‚", present: "å‘½è¿ä¹‹è½®è½¬åŠ¨ï¼Œæœºé‡æ¥ä¸´ï¼Œé¡ºåŠ¿è€Œä¸ºã€‚", future: "è¿åŠ¿å°†å‘ç”Ÿè½¬å˜ï¼Œå¥½è¿å³å°†åˆ°æ¥ã€‚" } },
        { name: "Justice", num: "XI", emoji: "âš–ï¸", 
          meanings: { past: "è¿‡å»çš„å†³å®šå¸¦æ¥äº†ç°åœ¨çš„æœï¼Œç§ç“œå¾—ç“œã€‚", present: "ä¿æŒå®¢è§‚å…¬æ­£ï¼Œç†æ€§åˆ†æï¼Œåšå‡ºå†³å®šã€‚", future: "çœŸç†å°†æ˜¾ç°ï¼Œä½ ä¼šå¾—åˆ°å…¬å¹³å¯¹å¾…ã€‚" } },
        { name: "The Hanged Man", num: "XII", emoji: "ğŸ¦‡", 
          meanings: { past: "è¿‡å»ç»å†åœæ»ï¼Œè¢«è¿«åšå‡ºäº†ç‰ºç‰²ã€‚", present: "æ¢ä¸ªè§’åº¦çœ‹ä¸–ç•Œï¼Œé€€è®©æ˜¯ä¸ºäº†å‰è¿›ã€‚", future: "æ–°è§†è§’å°†å¸¦æ¥é¡¿æ‚Ÿå’Œç²¾ç¥è‡ªç”±ã€‚" } },
        { name: "Death", num: "XIII", emoji: "ğŸ’€", 
          meanings: { past: "è¿‡å»ç»“æŸäº†ä¸€æ®µå…³ç³»ï¼Œå¸¦æ¥äº†å¿…ç„¶æ”¹å˜ã€‚", present: "æ”¾æ‰‹çš„æ—¶åˆ»ï¼Œåªæœ‰ç»“æŸæ—§çš„ï¼Œæ–°çš„æ‰æ¥ã€‚", future: "å½»åº•çš„é‡ç”Ÿï¼Œæ—§è²Œæ¢æ–°é¢œã€‚" } },
        { name: "Temperance", num: "XIV", emoji: "ğŸ¥¤", 
          meanings: { past: "è¿‡å»ä½ åœ¨å¯¹ç«‹ä¸­å¯»æ‰¾å¹³è¡¡ï¼Œä¿æŒç¨³å®šã€‚", present: "è€å¿ƒè°ƒå’Œï¼Œä¸è¦èµ°æç«¯ï¼Œå¹³è¡¡æ˜¯é“ã€‚", future: "ç”Ÿæ´»æ¢å¤å’Œè°ï¼Œèº«å¿ƒè¾¾åˆ°æœ€ä½³çŠ¶æ€ã€‚" } },
        { name: "The Devil", num: "XV", emoji: "ğŸ˜ˆ", 
          meanings: { past: "è¿‡å»è¢«æ¬²æœ›æŸç¼šï¼Œæ„Ÿåˆ°èº«ä¸ç”±å·±ã€‚", present: "å®¡è§†æ‰§å¿µï¼Œæ‰“ç ´æ·é”ï¼Œé‡è·è‡ªç”±ã€‚", future: "è­¦æƒ•è¯±æƒ‘ï¼Œä½ éšæ—¶å¯ä»¥æŒ£è„±ã€‚" } },
        { name: "The Tower", num: "XVI", emoji: "âš¡", 
          meanings: { past: "è¿‡å»çªå‘å˜æ•…æ‰“ç ´äº†ä½ çš„å®‰å…¨æ„Ÿã€‚", present: "è™½ç„¶æ··ä¹±ï¼Œä½†è¿™æ­£æ˜¯é‡å»ºåŸºçŸ³çš„æœºä¼šã€‚", future: "åºŸå¢Ÿä¹‹ä¸Šï¼Œå»ºç«‹æ›´çœŸå®åšå›ºçš„ç”Ÿæ´»ã€‚" } },
        { name: "The Star", num: "XVII", emoji: "ğŸŒŸ", 
          meanings: { past: "åœ¨é»‘æš—ä¸­ï¼Œä½ æ›¾æ‰¾åˆ°å¸Œæœ›çš„å¾®å…‰ã€‚", present: "ä¿æŒä¿¡å¿ƒï¼Œæ²»æ„ˆæ­£åœ¨å‘ç”Ÿï¼Œæ„¿æœ›å¯æˆã€‚", future: "å¸Œæœ›å’Œçµæ„ŸæŒ‡å¼•ä½ èµ°å‘å…‰æ˜ã€‚" } },
        { name: "The Moon", num: "XVIII", emoji: "ğŸŒ‘", 
          meanings: { past: "è¿‡å»é™·å…¥è¿·èŒ«ï¼Œçœ‹ä¸æ¸…äº‹æƒ…çœŸç›¸ã€‚", present: "ç›´è§‰æ•æ„Ÿä½†ä¸å®‰ï¼Œé¢å¯¹å†…å¿ƒææƒ§ã€‚", future: "è¿·é›¾æ•£å»ï¼Œæ½œæ„è¯†å¸¦æ¥æ·±åˆ»æ´è§ã€‚" } },
        { name: "The Sun", num: "XIX", emoji: "â˜€ï¸", 
          meanings: { past: "è¿‡å»æ˜¯å¿«ä¹ã€çº¯çœŸä¸”å……æ»¡æ´»åŠ›çš„ã€‚", present: "é˜´éœ¾æ•£å°½ï¼Œäº«å—å½“ä¸‹ï¼ŒæˆåŠŸåœ¨å³ã€‚", future: "å…‰æ˜æ™®ç…§ï¼Œå……æ»¡å–œæ‚¦ä¸ç§¯æèƒ½é‡ã€‚" } },
        { name: "Judgement", num: "XX", emoji: "ğŸ“¯", 
          meanings: { past: "å¬åˆ°å†…å¿ƒå¬å”¤ï¼Œåšå‡ºäº†æ”¹å˜äººç”Ÿçš„å†³å®šã€‚", present: "è§‰é†’æ—¶åˆ»ï¼Œå®¡è§†è¿‡å»ï¼Œé‡æ–°å‡ºå‘ã€‚", future: "çµé­‚å¤æ´»ä¸æ–°ä½¿å‘½ï¼Œè·å¾—æ–°ç”Ÿã€‚" } },
        { name: "The World", num: "XXI", emoji: "ğŸŒ", 
          meanings: { past: "è¿‡å»å®Œæˆäº†ä¸€ä¸ªé‡è¦é˜¶æ®µï¼Œè·å¾—åœ†æ»¡ã€‚", present: "ä¸€åˆ‡å°±ç»ªï¼Œäº«å—æˆåŠŸï¼Œå®Œç¾ç»“å±€ã€‚", future: "å¼€å¯æ–°ç¯‡ç« ï¼Œä¸–ç•Œæ‹¥æœ‰æ— é™å¯èƒ½ã€‚" } },
        { name: "Ace of Wands", num: "Ace", emoji: "ğŸ¥–", 
          meanings: { past: "å¼ºçƒˆçš„å†²åŠ¨æˆ–çµæ„Ÿæ›¾ç‚¹ç‡ƒä½ çš„çƒ­æƒ…ã€‚", present: "æŠ“ä½çµæ„Ÿï¼Œæœºä¼šç¨çºµå³é€ï¼Œè¡ŒåŠ¨ï¼", future: "å……æ»¡æ¿€æƒ…çš„æ–°é¡¹ç›®æˆ–å†’é™©ç­‰ç€ä½ ã€‚" } },
        { name: "Ace of Cups", num: "Ace", emoji: "ğŸ†", 
          meanings: { past: "æƒ…æ„ŸèŒèŠ½è®©ä½ ä½“éªŒåˆ°äº†çˆ±ä¸æµåŠ¨ã€‚", present: "æ•å¼€å¿ƒæ‰‰ï¼Œæ¥çº³æ–°æƒ…æ„Ÿï¼Œçˆ±åœ¨æ»‹é•¿ã€‚", future: "ä¸€æ®µæ–°æ„Ÿæƒ…å¼€å§‹ï¼Œæˆ–æƒ…æ„Ÿå¾—åˆ°æ»¡è¶³ã€‚" } }
    ];

    const uiLayer = document.getElementById('ui-layer');
    const instruction = document.getElementById('instruction');
    const cursor = document.getElementById('cursor');
    const loader = document.getElementById('loader');
    const readingPanel = document.getElementById('reading-panel');

    // --- æ ¸å¿ƒé…ç½® ---
    const MAX_CARDS = 24; 
    const TARGET_SELECTION = 3;
    let cards = [];
    let selectedCards = [];
    let mode = 'waiting'; // waiting, spread, selecting, finished, resetting
    let resetTimer = null;

    // --- åˆå§‹åŒ– ---
    function initCards() {
        uiLayer.innerHTML = '';
        cards = [];
        selectedCards = [];
        
        for (let i = 0; i < MAX_CARDS; i++) {
            const card = document.createElement('div');
            card.classList.add('card');
            card.dataset.index = i % tarotData.length;

            const back = document.createElement('div');
            back.classList.add('card-face', 'card-back');
            const cat = document.createElement('div');
            cat.className = 'cat-silhouette';
            const eyes = document.createElement('div');
            eyes.className = 'cat-eyes';
            cat.appendChild(eyes);
            back.appendChild(cat);
            
            const front = document.createElement('div');
            front.classList.add('card-face', 'card-front');
            const data = tarotData[i % tarotData.length];
            front.innerHTML = `
                <div class="tarot-content">
                    <div class="tarot-num">${data.num}</div>
                    <div class="tarot-emoji">${data.emoji}</div>
                    <div class="tarot-name">${data.name}</div>
                </div>
            `;
            
            card.appendChild(back);
            card.appendChild(front);
            card.style.transform = `translate(-50%, -50%) scale(0.5) translateZ(-300px)`;
            
            uiLayer.appendChild(card);
            cards.push(card);
        }
        
        mode = 'waiting';
        instruction.innerHTML = "é—­çœ¼å†¥æƒ³ <span class='highlight'>å¼ å¼€æ‰‹æŒ</span> å”¤é†’ç‰Œé˜µ";
        cursor.style.display = 'none';
        readingPanel.classList.remove('show');
    }

    // --- é€»è¾‘ï¼šç‚¸å¼€ç‰Œé˜µ ---
    function spreadCards() {
        if (mode !== 'waiting') return;
        mode = 'spread';
        instruction.innerHTML = "ç«–èµ· <span class='highlight'>â˜ï¸é£ŸæŒ‡</span> é€‰æ‹©ä½ çš„å‘½è¿ (0/3)";
        
        cards.forEach((card, i) => {
            const maxW = window.innerWidth * 0.45;
            const maxH = window.innerHeight * 0.35;
            
            const randomX = (Math.random() - 0.5) * 2 * maxW;
            const randomY = (Math.random() - 0.5) * 2 * maxH - 30;
            const randomRot = (Math.random() - 0.5) * 40;
            const randomZ = Math.random() * 200; 
            
            card.dataset.baseTransform = `translate(calc(-50% + ${randomX}px), calc(-50% + ${randomY}px)) translateZ(${randomZ}px) rotate(${randomRot}deg)`;
            
            setTimeout(() => {
                card.style.transform = card.dataset.baseTransform;
            }, i * 30);
        });

        setTimeout(() => { mode = 'selecting'; }, 1200);
    }

    // --- é€»è¾‘ï¼šç”Ÿæˆè§£è¯» ---
    function generateReading() {
        if (selectedCards.length !== 3) return;

        const idx1 = parseInt(selectedCards[0].dataset.index);
        const idx2 = parseInt(selectedCards[1].dataset.index);
        const idx3 = parseInt(selectedCards[2].dataset.index);

        const data1 = tarotData[idx1];
        const data2 = tarotData[idx2];
        const data3 = tarotData[idx3];

        document.getElementById('text-past').innerHTML = 
            `<strong>${data1.name}:</strong> ${data1.meanings.past}`;
        document.getElementById('text-present').innerHTML = 
            `<strong>${data2.name}:</strong> ${data2.meanings.present}`;
        document.getElementById('text-future').innerHTML = 
            `<strong>${data3.name}:</strong> ${data3.meanings.future}`;

        readingPanel.classList.add('show');
        instruction.innerHTML = "å‘½è¿å·²æ˜¾ç°...";

        // 10ç§’åæç¤ºé‡ç½®
        if (resetTimer) clearTimeout(resetTimer);
        resetTimer = setTimeout(() => {
            if (mode === 'finished') {
                instruction.innerHTML = "ç°åœ¨ï¼Œ<span class='highlight'>å¼ å¼€æ‰‹æŒ</span> é‡æ–°æ´—ç‰Œ";
            }
        }, 10000);
    }

    // --- é€»è¾‘ï¼šæ‰‹åŠ¿å…‰æ ‡äº¤äº’ ---
    let lastHoverCard = null;
    let hoverStartTime = 0;

    function handleHandCursor(x, y) {
        if (mode !== 'selecting') return;

        cursor.style.display = 'block';
        cursor.style.left = x + 'px';
        cursor.style.top = y + 'px';

        let hitCard = null;
        let minDist = 9999;

        cards.forEach(card => {
            if (card.classList.contains('selected')) return;

            const rect = card.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const dist = Math.hypot(x - centerX, y - centerY);
            
            if (dist < 70 && dist < minDist) {
                minDist = dist;
                hitCard = card;
            }
        });

        if (hitCard) {
            if (lastHoverCard !== hitCard) {
                if (lastHoverCard) resetCardStyle(lastHoverCard);
                lastHoverCard = hitCard;
                hoverStartTime = Date.now();
                
                hitCard.style.transform = hitCard.dataset.baseTransform + " scale(1.15) translateZ(50px)";
                hitCard.style.zIndex = 100;
                hitCard.style.boxShadow = "0 0 20px #fff";
            } else {
                if (Date.now() - hoverStartTime > 600) { 
                    selectCard(hitCard);
                    lastHoverCard = null;
                }
            }
        } else {
            if (lastHoverCard) {
                resetCardStyle(lastHoverCard);
                lastHoverCard = null;
            }
        }
    }

    function resetCardStyle(card) {
        if (!card.classList.contains('selected')) {
            card.style.transform = card.dataset.baseTransform;
            card.style.zIndex = "";
            card.style.boxShadow = "";
        }
    }

    function selectCard(card) {
        if (selectedCards.length >= TARGET_SELECTION) return;
        
        selectedCards.push(card);
        card.classList.add('selected');
        
        const slotClasses = ['slot-1', 'slot-2', 'slot-3'];
        card.classList.add('slot-active', slotClasses[selectedCards.length - 1]);
        
        card.style.transform = 'translate(-50%, 0) rotateY(0deg)'; 
        card.style.zIndex = 1000;

        instruction.innerHTML = `å·²é€‰æ‹© (${selectedCards.length}/3)`;

        setTimeout(() => {
            card.style.transform = 'translate(-50%, 0) rotateY(180deg)';
        }, 800);

        if (selectedCards.length === TARGET_SELECTION) {
            setTimeout(() => {
                mode = 'finished';
                instruction.innerHTML = "æ­£åœ¨è§£è¯»å‘½è¿...";
                cursor.style.display = 'none';
                setTimeout(generateReading, 1500); 
            }, 1000);
        }
    }

    // --- é€»è¾‘ï¼šè‡ªåŠ¨é‡ç½®å¹¶é‡æ–°å¼€å§‹ ---
    function resetAndRestart() {
        if (mode !== 'finished') return;
        mode = 'resetting';
        if (resetTimer) clearTimeout(resetTimer);
        
        // 1. å…³é—­ç­”æ¡ˆ
        readingPanel.classList.remove('show');
        instruction.innerHTML = "å‘½è¿ä¹‹è½®é‡æ–°è½¬åŠ¨...";

        // 2. é€‰ä¸­çš„ç‰Œç¿»å›èƒŒé¢
        selectedCards.forEach(card => {
            card.style.transform = 'translate(-50%, 0) rotateY(0deg)';
        });

        // 3. 1ç§’åï¼Œæ‰€æœ‰ç‰Œå›æ”¶å¹¶æ´—ç‰Œ
        setTimeout(() => {
            cards.forEach(card => {
                card.classList.remove('selected', 'slot-active', 'slot-1', 'slot-2', 'slot-3');
                card.style.left = '';
                card.style.top = '';
                card.style.zIndex = '';
                card.style.boxShadow = '';
                // å›åˆ°ä¸­å¿ƒå †å 
                card.style.transform = `translate(-50%, -50%) scale(0.5) translateZ(-300px)`;
            });
            selectedCards = [];

            // 4. æ´—ç‰ŒåŠ¨ç”»å®Œæˆåï¼Œè‡ªåŠ¨é‡æ–°å±•å¼€ (Auto Spread)
            setTimeout(() => {
                mode = 'waiting'; // ç¬é—´å›åˆ° waiting çŠ¶æ€ä¾› spreadCards è¯»å–
                spreadCards();    // è‡ªåŠ¨è§¦å‘å±•å¼€
            }, 1500); // 1.5ç§’æ´—ç‰Œæ—¶é—´
            
        }, 1000);
    }

    // --- è§†è§‰è¯†åˆ« ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');

    function onResults(results) {
        if (loader.style.display !== 'none') loader.style.display = 'none';

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.filter = "grayscale(100%) brightness(1.5)"; 
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.restore();
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: 'rgba(255,255,255,0.2)', lineWidth: 1});
            
            const tips = [landmarks[8], landmarks[12], landmarks[16], landmarks[20]];
            const pips = [landmarks[6], landmarks[10], landmarks[14], landmarks[18]];
            
            const fingersUp = tips.map((tip, i) => tip.y < pips[i].y);
            const indexUp = fingersUp[0];
            const othersUp = fingersUp[1] && fingersUp[2] && fingersUp[3];
            const othersDown = !fingersUp[1] && !fingersUp[2] && !fingersUp[3];

            // é€»è¾‘ A: å¼ å¼€æ‰‹æŒ (Waiting -> Spread) OR (Finished -> Reset)
            if (indexUp && othersUp) {
                if (mode === 'waiting') spreadCards();
                if (mode === 'finished') resetAndRestart();
            }

            // é€»è¾‘ B: é£ŸæŒ‡é€‰ç‰Œ
            if (mode === 'selecting' && indexUp && othersDown) {
                const x = (1 - landmarks[8].x) * window.innerWidth;
                const y = landmarks[8].y * window.innerHeight;
                handleHandCursor(x, y);
            } else if (mode === 'selecting') {
                cursor.style.display = 'none';
                if(lastHoverCard) {
                    resetCardStyle(lastHoverCard);
                    lastHoverCard = null;
                }
            }
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280, height: 720
    });
    camera.start();
    
    window.addEventListener('resize', () => {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
    });
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;
    
    initCards();

</script>
</body>
</html>


